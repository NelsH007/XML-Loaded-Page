# -*- coding: utf-8 -*-
import scrapy
import json

class DemoXHRPostSpider(scrapy.Spider):
    name = 'post_xhr'
    payload = """
            {"categoryId":"4","manufacturerId":"0","vendorId":"0","priceRangeFilterModel7Spikes":{"CategoryId":"4","ManufacturerId":"0","VendorId":"0","SelectedPriceRange":{},"MinPrice":"1050","MaxPrice":"14750"},"specificationFiltersModel7Spikes":{"CategoryId":"4","ManufacturerId":"0","VendorId":"0","SpecificationFilterGroups":[{"Id":27,"FilterItems":[{"Id":"5362","FilterItemState":"Unchecked"},{"Id":"103","FilterItemState":"Unchecked"},{"Id":"104","FilterItemState":"Unchecked"},{"Id":"110","FilterItemState":"Unchecked"},{"Id":"5360","FilterItemState":"Unchecked"},{"Id":"3854","FilterItemState":"Unchecked"},{"Id":"2626","FilterItemState":"Unchecked"}]},{"Id":20,"FilterItems":[{"Id":"90","FilterItemState":"Unchecked"},{"Id":"92","FilterItemState":"Unchecked"},{"Id":"93","FilterItemState":"Unchecked"},{"Id":"99","FilterItemState":"Unchecked"}]},{"Id":11,"FilterItems":[{"Id":"302","FilterItemState":"Unchecked"},{"Id":"2494","FilterItemState":"Unchecked"}]},{"Id":6,"FilterItems":[{"Id":"2461","FilterItemState":"Unchecked"},{"Id":"21","FilterItemState":"Unchecked"},{"Id":"24","FilterItemState":"Unchecked"},{"Id":"25","FilterItemState":"Unchecked"},{"Id":"26","FilterItemState":"Unchecked"}]},{"Id":7,"FilterItems":[{"Id":"5346","FilterItemState":"Unchecked"}]},{"Id":5,"FilterItems":[{"Id":"2742","FilterItemState":"Unchecked"},{"Id":"2743","FilterItemState":"Unchecked"},{"Id":"3493","FilterItemState":"Unchecked"}]},{"Id":2,"FilterItems":[{"Id":"8","FilterItemState":"Unchecked"},{"Id":"1451","FilterItemState":"Unchecked"},{"Id":"1123","FilterItemState":"Unchecked"}]},{"Id":8,"FilterItems":[{"Id":"61","FilterItemState":"Unchecked"},{"Id":"3458","FilterItemState":"Unchecked"},{"Id":"3719","FilterItemState":"Unchecked"}]},{"Id":334,"FilterItems":[{"Id":"2489","FilterItemState":"Unchecked"},{"Id":"2488","FilterItemState":"Unchecked"},{"Id":"2487","FilterItemState":"Unchecked"}]},{"Id":628,"FilterItems":[{"Id":"5079","FilterItemState":"Unchecked"}]},{"Id":680,"FilterItems":[{"Id":"4791","FilterItemState":"Unchecked"},{"Id":"4935","FilterItemState":"Unchecked"},{"Id":"5364","FilterItemState":"Unchecked"},{"Id":"6333","FilterItemState":"Unchecked"}]},{"Id":681,"FilterItems":[{"Id":"4792","FilterItemState":"Unchecked"}]}]},"manufacturerFiltersModel7Spikes":{"CategoryId":"4","ManufacturerFilterItems":[{"Id":"196","FilterItemState":"Unchecked"},{"Id":"197","FilterItemState":"Unchecked"},{"Id":"2","FilterItemState":"Unchecked"},{"Id":"1","FilterItemState":"Unchecked"},{"Id":"6","FilterItemState":"Unchecked"},{"Id":"44","FilterItemState":"Unchecked"},{"Id":"108","FilterItemState":"Unchecked"}]},"pageNumber":1,"orderby":"10","viewmode":"grid","pagesize":0,"queryString":"#/pageSize=10&viewMode=grid&orderBy=10","shouldNotStartFromFirstPage":false,"keyword":"","searchCategoryId":"0","searchManufacturerId":"0","searchVendorId":"0","priceFrom":"","priceTo":"","includeSubcategories":"False","searchInProductDescriptions":"False","advancedSearch":"False","isOnSearchPage":"False"}
            """
    attemp=0
    def start_requests(self):
        yield scrapy.Request(url="http://eastasiaeg.com/de/getFilteredProducts", method='POST',
                             body=self.payload, headers={'content-type': 'application/json'})

    def parse(self, response):
        for product in response.xpath('//div[@class="product-item"]'):
            yield {
                'product_name': product.xpath('.//div[@class="details"]/h2/a/text()').extract_first()
            }
        self.attemp+=1
        payload_2 ='''
            {"categoryId":"4","manufacturerId":"0","vendorId":"0","priceRangeFilterModel7Spikes":{"CategoryId":"4","ManufacturerId":"0","VendorId":"0","SelectedPriceRange":{},"MinPrice":"1050","MaxPrice":"14750"},"specificationFiltersModel7Spikes":{"CategoryId":"4","ManufacturerId":"0","VendorId":"0","SpecificationFilterGroups":[{"Id":27,"FilterItems":[{"Id":"5362","FilterItemState":"Unchecked"},{"Id":"103","FilterItemState":"Unchecked"},{"Id":"104","FilterItemState":"Unchecked"},{"Id":"110","FilterItemState":"Unchecked"},{"Id":"5360","FilterItemState":"Unchecked"},{"Id":"3854","FilterItemState":"Unchecked"},{"Id":"2626","FilterItemState":"Unchecked"}]},{"Id":20,"FilterItems":[{"Id":"90","FilterItemState":"Unchecked"},{"Id":"92","FilterItemState":"Unchecked"},{"Id":"93","FilterItemState":"Unchecked"},{"Id":"99","FilterItemState":"Unchecked"}]},{"Id":11,"FilterItems":[{"Id":"302","FilterItemState":"Unchecked"},{"Id":"2494","FilterItemState":"Unchecked"}]},{"Id":6,"FilterItems":[{"Id":"2461","FilterItemState":"Unchecked"},{"Id":"21","FilterItemState":"Unchecked"},{"Id":"24","FilterItemState":"Unchecked"},{"Id":"25","FilterItemState":"Unchecked"},{"Id":"26","FilterItemState":"Unchecked"}]},{"Id":7,"FilterItems":[{"Id":"5346","FilterItemState":"Unchecked"}]},{"Id":5,"FilterItems":[{"Id":"2742","FilterItemState":"Unchecked"},{"Id":"2743","FilterItemState":"Unchecked"},{"Id":"3493","FilterItemState":"Unchecked"}]},{"Id":2,"FilterItems":[{"Id":"8","FilterItemState":"Unchecked"},{"Id":"1451","FilterItemState":"Unchecked"},{"Id":"1123","FilterItemState":"Unchecked"}]},{"Id":8,"FilterItems":[{"Id":"61","FilterItemState":"Unchecked"},{"Id":"3458","FilterItemState":"Unchecked"},{"Id":"3719","FilterItemState":"Unchecked"}]},{"Id":334,"FilterItems":[{"Id":"2489","FilterItemState":"Unchecked"},{"Id":"2488","FilterItemState":"Unchecked"},{"Id":"2487","FilterItemState":"Unchecked"}]},{"Id":628,"FilterItems":[{"Id":"5079","FilterItemState":"Unchecked"}]},{"Id":680,"FilterItems":[{"Id":"4791","FilterItemState":"Unchecked"},{"Id":"4935","FilterItemState":"Unchecked"},{"Id":"5364","FilterItemState":"Unchecked"},{"Id":"6333","FilterItemState":"Unchecked"}]},{"Id":681,"FilterItems":[{"Id":"4792","FilterItemState":"Unchecked"}]}]},"manufacturerFiltersModel7Spikes":{"CategoryId":"4","ManufacturerFilterItems":[{"Id":"196","FilterItemState":"Unchecked"},{"Id":"197","FilterItemState":"Unchecked"},{"Id":"2","FilterItemState":"Unchecked"},{"Id":"1","FilterItemState":"Unchecked"},{"Id":"6","FilterItemState":"Unchecked"},{"Id":"44","FilterItemState":"Unchecked"},{"Id":"108","FilterItemState":"Unchecked"}]},"pageNumber":2,"orderby":"10","viewmode":"grid","pagesize":0,"queryString":"","shouldNotStartFromFirstPage":true,"keyword":"","searchCategoryId":"0","searchManufacturerId":"0","searchVendorId":"0","priceFrom":"","priceTo":"","includeSubcategories":"False","searchInProductDescriptions":"False","advancedSearch":"False","isOnSearchPage":"False"}'''
        if self.attemp < 4:
            payload_use = json.loads(payload_2)
            payload_use['pageNumber'] = self.attemp
            yield scrapy.Request(url="http://eastasiaeg.com/de/getFilteredProducts", method='POST',
                               body=json.dumps(payload_use), headers={'content-type': 'application/json'}, callback=self.parse)

